{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
    .student-management {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .student-section {
        margin: 10px 0;
    }
    .student-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #eee;
        padding: 10px;
        margin: 10px 0;
    }
    .student-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px;
        border-bottom: 1px solid #eee;
    }
    .student-item:last-child {
        border-bottom: none;
    }
    .filter-section {
        margin: 10px 0;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 4px;
    }
    .error-message {
        color: red;
        margin: 10px 0;
    }
    .success-message {
        color: green;
        margin: 10px 0;
    }
    .loading {
        opacity: 0.5;
        pointer-events: none;
    }
    .button-group {
        margin: 10px 0;
        display: flex;
        gap: 10px;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get the course ID from the URL since we're in the admin change form
    const urlParts = window.location.pathname.split('/');
    const courseId = urlParts[urlParts.indexOf('course') + 1];
    console.log('Course ID from URL:', courseId);
    
    if (!courseId) {
        console.error('Could not find course ID from URL');
        return;
    }

    const registeredStudentsList = document.getElementById('registered-students');
    const availableStudentsList = document.getElementById('available-students');
    const gradeFilter = document.getElementById('grade-filter');
    const searchFilter = document.getElementById('search-filter');
    const capacityDisplay = document.getElementById('capacity-display');
    const errorDisplay = document.getElementById('error-display');
    const successDisplay = document.getElementById('success-display');
    
    // Debug log for DOM elements
    console.log('DOM Elements found:', {
        registeredStudentsList: !!registeredStudentsList,
        availableStudentsList: !!availableStudentsList,
        gradeFilter: !!gradeFilter,
        searchFilter: !!searchFilter,
        capacityDisplay: !!capacityDisplay,
        errorDisplay: !!errorDisplay,
        successDisplay: !!successDisplay
    });
    
    let availableStudents = [];
    let registeredStudents = [];
    let courseGrade = null;
    let availableGrades = [];
    
    function showError(message) {
        if (errorDisplay) {
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
            setTimeout(() => {
                errorDisplay.style.display = 'none';
            }, 5000);
        }
    }
    
    function showSuccess(message) {
        if (successDisplay) {
            successDisplay.textContent = message;
            successDisplay.style.display = 'block';
            setTimeout(() => {
                successDisplay.style.display = 'none';
            }, 3000);
        }
    }
    
    function updateCapacityDisplay() {
        if (capacityDisplay) {
            const registered = registeredStudents ? registeredStudents.length : 0;
            capacityDisplay.textContent = `Currently Registered: ${registered}`;
        }
    }
    
    async function loadRegisteredStudents() {
        try {
            console.log('Fetching registered students for course:', courseId);
            if (registeredStudentsList) {
                registeredStudentsList.classList.add('loading');
            }
            const response = await fetch(`/admin/scheduler/course/${courseId}/registered-students/`);
            console.log('Registered students response status:', response.status);
            
            const data = await response.json();
            console.log('Registered students data:', data);
            
            if (!data || !Array.isArray(data.students)) {
                throw new Error('Invalid response format');
            }
            
            registeredStudents = data.students;
            courseGrade = data.course_grade;
            
            console.log('Number of registered students:', registeredStudents.length);
            
            if (registeredStudentsList) {
                registeredStudentsList.innerHTML = '';
                if (registeredStudents.length === 0) {
                    registeredStudentsList.innerHTML = '<div class="student-item">No students currently registered</div>';
                } else {
                    data.students.forEach(student => {
                        const div = document.createElement('div');
                        div.className = 'student-item';
                        div.innerHTML = `
                            <span>${student.first_name} ${student.last_name} (Grade ${student.grade_level})</span>
                            <button onclick="removeStudent(${student.id})">Remove</button>
                        `;
                        registeredStudentsList.appendChild(div);
                    });
                }
            }
            updateCapacityDisplay();
        } catch (error) {
            console.error('Error in loadRegisteredStudents:', error);
            showError('Error loading registered students: ' + error.message);
        } finally {
            if (registeredStudentsList) {
                registeredStudentsList.classList.remove('loading');
            }
        }
    }
    
    async function loadAvailableStudents() {
        try {
            console.log('Fetching available students for course:', courseId);
            if (availableStudentsList) {
                availableStudentsList.classList.add('loading');
            }
            const response = await fetch(`/admin/scheduler/course/${courseId}/available-students/`);
            console.log('Available students response status:', response.status);
            
            const data = await response.json();
            console.log('Available students data:', data);
            
            if (!data || !Array.isArray(data.students)) {
                throw new Error('Invalid response format');
            }
            
            availableStudents = data.students;
            availableGrades = data.available_grades || [];
            courseGrade = data.course_grade;
            
            console.log('Number of available students:', availableStudents.length);
            console.log('Available grades:', availableGrades);
            
            if (gradeFilter) {
                // Store current selection or use course grade for initial load
                const currentSelection = gradeFilter.value || courseGrade?.toString();
                
                gradeFilter.innerHTML = '<option value="">All Grades</option>';
                availableGrades.forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade;
                    option.textContent = `Grade ${grade}`;
                    gradeFilter.appendChild(option);
                });
                
                // Restore previous selection or use course grade if it exists in the options
                if (currentSelection && availableGrades.includes(parseInt(currentSelection))) {
                    gradeFilter.value = currentSelection;
                }
            }
            
            filterAndDisplayAvailableStudents();
        } catch (error) {
            console.error('Error in loadAvailableStudents:', error);
            showError('Error loading available students: ' + error.message);
        } finally {
            if (availableStudentsList) {
                availableStudentsList.classList.remove('loading');
            }
        }
    }
    
    function filterAndDisplayAvailableStudents() {
        if (!availableStudentsList) return;
        
        const gradeValue = gradeFilter ? gradeFilter.value : '';
        const searchValue = searchFilter ? searchFilter.value.toLowerCase() : '';
        
        console.log('Filtering students with:', { gradeValue, searchValue }); // Debug log
        
        const filteredStudents = availableStudents.filter(student => {
            const matchesGrade = !gradeValue || student.grade_level.toString() === gradeValue;
            const matchesSearch = !searchValue || 
                student.first_name.toLowerCase().includes(searchValue) || 
                student.last_name.toLowerCase().includes(searchValue);
            return matchesGrade && matchesSearch;
        });
        
        console.log('Filtered students count:', filteredStudents.length); // Debug log
        
        availableStudentsList.innerHTML = '';
        if (filteredStudents.length === 0) {
            availableStudentsList.innerHTML = '<div class="student-item">No available students found</div>';
        } else {
            filteredStudents.forEach(student => {
                const div = document.createElement('div');
                div.className = 'student-item';
                div.innerHTML = `
                    <span>${student.first_name} ${student.last_name} (Grade ${student.grade_level})</span>
                    <button onclick="addStudent(${student.id})">Add</button>
                `;
                availableStudentsList.appendChild(div);
            });
        }
    }
    
    window.addStudent = async function(studentId) {
        try {
            const response = await fetch(`/admin/scheduler/course/${courseId}/add-student/${studentId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Failed to add student');
            }
            
            showSuccess('Student added successfully');
            await Promise.all([loadRegisteredStudents(), loadAvailableStudents()]);
        } catch (error) {
            showError(error.message);
        }
    };
    
    window.removeStudent = async function(studentId) {
        try {
            const response = await fetch(`/admin/scheduler/course/${courseId}/remove-student/${studentId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Failed to remove student');
            }
            
            showSuccess('Student removed successfully');
            await Promise.all([loadRegisteredStudents(), loadAvailableStudents()]);
        } catch (error) {
            showError(error.message);
        }
    };
    
    window.removeAllStudents = async function() {
        if (!confirm('Are you sure you want to remove all students from this course?')) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/scheduler/course/${courseId}/remove-all-students/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Failed to remove all students');
            }
            
            showSuccess('All students removed successfully');
            await Promise.all([loadRegisteredStudents(), loadAvailableStudents()]);
        } catch (error) {
            showError(error.message);
        }
    };
    
    window.addAllFilteredStudents = async function() {
        const gradeValue = gradeFilter ? gradeFilter.value : '';
        const searchValue = searchFilter ? searchFilter.value.toLowerCase() : '';
        
        const filteredStudents = availableStudents.filter(student => {
            const matchesGrade = !gradeValue || student.grade_level.toString() === gradeValue;
            const matchesSearch = !searchValue || 
                student.first_name.toLowerCase().includes(searchValue) || 
                student.last_name.toLowerCase().includes(searchValue);
            return matchesGrade && matchesSearch;
        });
        
        if (filteredStudents.length === 0) {
            showError('No students available to add');
            return;
        }
        
        if (!confirm(`Are you sure you want to add ${filteredStudents.length} students to this course?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/scheduler/course/${courseId}/add-students/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ student_ids: filteredStudents.map(s => s.id) })
            });
            
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Failed to add students');
            }
            
            showSuccess('Students added successfully');
            await Promise.all([loadRegisteredStudents(), loadAvailableStudents()]);
        } catch (error) {
            showError(error.message);
        }
    };
    
    // Set up event listeners
    if (gradeFilter) {
        gradeFilter.addEventListener('change', filterAndDisplayAvailableStudents);
    }
    if (searchFilter) {
        searchFilter.addEventListener('input', filterAndDisplayAvailableStudents);
    }
    
    // Initial load
    loadRegisteredStudents();
    loadAvailableStudents();
});
</script>
{% endblock %}

{% block content %}
{{ block.super }}
<div class="student-management">
    <h2>Student Management</h2>
    <div id="error-display" class="error-message" style="display: none;"></div>
    <div id="success-display" class="success-message" style="display: none;"></div>
    
    <div class="student-section">
        <h3>Course Capacity</h3>
        <div id="capacity-display"></div>
    </div>
    
    <div class="student-section">
        <h3>Registered Students</h3>
        <div class="button-group">
            <button onclick="removeAllStudents()">Remove All Students</button>
        </div>
        <div id="registered-students" class="student-list"></div>
    </div>
    
    <div class="student-section">
        <h3>Available Students</h3>
        <div class="filter-section">
            <label>
                Grade Level:
                <select id="grade-filter">
                    <option value="">All Grades</option>
                </select>
            </label>
            <label>
                Search:
                <input type="text" id="search-filter" placeholder="Search by name...">
            </label>
        </div>
        <div class="button-group">
            <button onclick="addAllFilteredStudents()">Add All Filtered</button>
        </div>
        <div id="available-students" class="student-list"></div>
    </div>
</div>
{% endblock %} 