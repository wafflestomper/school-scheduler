{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<style>
    .distribution-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    .distribution-table th, .distribution-table td {
        padding: 8px;
        border: 1px solid #ddd;
        text-align: left;
    }
    .distribution-table th {
        background-color: #f5f5f5;
    }
    .action-buttons {
        margin: 20px 0;
    }
    .action-button {
        background-color: #79aec8;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        margin-right: 10px;
    }
    .action-button:hover {
        background-color: #417690;
    }
    .section-details {
        margin-top: 10px;
        padding-left: 20px;
    }
    .message {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
    }
    .success {
        background-color: #dff0d8;
        border: 1px solid #d6e9c6;
        color: #3c763d;
    }
    .error {
        background-color: #f2dede;
        border: 1px solid #ebccd1;
        color: #a94442;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>Course Distribution Management</h1>
    
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="action-buttons">
        <button class="action-button" onclick="distributeAll()">Distribute All Courses</button>
        <button class="action-button" onclick="clearAllDistributions()">Clear All Distributions</button>
    </div>

    <table class="distribution-table">
        <thead>
            <tr>
                <th>Course</th>
                <th>Grade Level</th>
                <th>Total Students</th>
                <th>Number of Sections</th>
                <th>Distribution Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for course in courses %}
            <tr id="course-row-{{ course.id }}">
                <td>{{ course.name }} ({{ course.code }})</td>
                <td>{{ course.grade_level }}</td>
                <td>{{ course.total_students }}</td>
                <td>{{ course.num_sections }}</td>
                <td id="status-{{ course.id }}">
                    {% if course.is_distributed %}
                    Distributed
                    {% else %}
                    Not Distributed
                    {% endif %}
                </td>
                <td>
                    <button class="action-button" onclick="distributeCourse({{ course.id }})">Distribute</button>
                    <button class="action-button" onclick="clearDistribution({{ course.id }})">Clear</button>
                    <button class="action-button" onclick="toggleDetails({{ course.id }})">Show Details</button>
                </td>
            </tr>
            <tr id="details-{{ course.id }}" style="display: none;">
                <td colspan="6">
                    <div class="section-details" id="section-details-{{ course.id }}">
                        Loading section details...
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
async function distributeCourse(courseId) {
    try {
        const response = await fetch(`/admin/scheduler/course/api/distribute/${courseId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        const data = await response.json();
        if (data.success) {
            document.getElementById(`status-${courseId}`).textContent = 'Distributed';
            showMessage('Distribution successful', 'success');
            await loadSectionDetails(courseId);
        } else {
            showMessage(data.error || 'Distribution failed', 'error');
        }
    } catch (error) {
        showMessage('Error during distribution', 'error');
    }
}

async function clearDistribution(courseId) {
    try {
        const response = await fetch(`/admin/scheduler/course/api/clear-distribution/${courseId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        const data = await response.json();
        if (data.success) {
            document.getElementById(`status-${courseId}`).textContent = 'Not Distributed';
            showMessage('Distribution cleared', 'success');
            await loadSectionDetails(courseId);
        } else {
            showMessage(data.error || 'Failed to clear distribution', 'error');
        }
    } catch (error) {
        showMessage('Error clearing distribution', 'error');
    }
}

async function distributeAll() {
    try {
        const response = await fetch('/admin/scheduler/course/api/distribute-all/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        const data = await response.json();
        if (data.success) {
            showMessage('All courses distributed successfully', 'success');
            location.reload();
        } else {
            showMessage(data.error || 'Failed to distribute all courses', 'error');
        }
    } catch (error) {
        showMessage('Error during distribution', 'error');
    }
}

async function clearAllDistributions() {
    try {
        const response = await fetch('/admin/scheduler/course/api/clear-all-distributions/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        const data = await response.json();
        if (data.success) {
            showMessage('All distributions cleared', 'success');
            location.reload();
        } else {
            showMessage(data.error || 'Failed to clear all distributions', 'error');
        }
    } catch (error) {
        showMessage('Error clearing distributions', 'error');
    }
}

async function loadSectionDetails(courseId) {
    try {
        const response = await fetch(`/admin/scheduler/course/api/course-distribution/${courseId}/`);
        const data = await response.json();
        if (data.success) {
            const detailsDiv = document.getElementById(`section-details-${courseId}`);
            let html = '<h3>Section Details</h3>';
            
            if (data.distribution && data.distribution.length > 0) {
                data.distribution.forEach(section => {
                    html += `
                        <div class="section">
                            <h4>${section.section_name}</h4>
                            <p>Students: ${section.student_count}</p>
                            <ul>
                                ${section.students.map(student => 
                                    `<li>${student.first_name} ${student.last_name}</li>`
                                ).join('')}
                            </ul>
                        </div>
                    `;
                });
            } else {
                html += '<p>No sections or students distributed yet.</p>';
            }
            
            detailsDiv.innerHTML = html;
        } else {
            showMessage(data.error || 'Error loading section details', 'error');
        }
    } catch (error) {
        showMessage('Error loading section details', 'error');
    }
}

function toggleDetails(courseId) {
    const detailsRow = document.getElementById(`details-${courseId}`);
    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        loadSectionDetails(courseId);
    } else {
        detailsRow.style.display = 'none';
    }
}

function showMessage(message, type) {
    const messagesDiv = document.querySelector('.messages');
    if (!messagesDiv) {
        const newMessagesDiv = document.createElement('div');
        newMessagesDiv.className = 'messages';
        document.querySelector('#content-main').insertBefore(newMessagesDiv, document.querySelector('.action-buttons'));
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.textContent = message;
    
    document.querySelector('.messages').appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
        if (document.querySelector('.messages').children.length === 0) {
            document.querySelector('.messages').remove();
        }
    }, 5000);
}
</script>
{% endblock %} 